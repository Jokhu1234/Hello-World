!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).abReader={})}(this,(function(e){"use strict";function t(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{l(r.next(e))}catch(e){i(e)}}function c(e){try{l(r.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}l((r=r.apply(e,t||[])).next())}))}function n(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}function r(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,n(o.key),o)}}function o(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,a,c=[],l=!0,u=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=i.call(n)).done)&&(c.push(r.value),c.length!==t);l=!0);}catch(e){u=!0,o=e}finally{try{if(!l&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(u)throw o}}return c}}(e,t)||a(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(e){return function(e){if(Array.isArray(e))return c(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||a(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function a(e,t){if(e){if("string"==typeof e)return c(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?c(e,t):void 0}}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var l={};Object.defineProperty(l,"__esModule",{value:!0});var u=l.getRootCookieDomain=void 0;u=l.getRootCookieDomain=function(e){if(!e||e.startsWith("localhost")||e.startsWith("127.0.0.1"))return e;var t=["co.uk","co.nz","com.au"].some((function(t){return e.endsWith(t)}))?3:2,n=e.startsWith("staging")?"staging.":"",r=e.split(".");return".".concat(n).concat(r.slice(r.length-t,r.length).join("."))};var s=function(e){var t,n=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=a(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,c=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return c=e.done,e},e:function(e){l=!0,i=e},f:function(){try{c||null==n.return||n.return()}finally{if(l)throw i}}}}(document.cookie?document.cookie.split("; "):[]);try{for(n.s();!(t=n.n()).done;){var r=t.value.split("=");if(r[0]===e)return r.slice(1).join("=")}}catch(e){n.e(e)}finally{n.f()}return null};let d;const f=new Uint8Array(16);function p(){if(!d&&(d="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!d))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return d(f)}const y=[];for(let e=0;e<256;++e)y.push((e+256).toString(16).slice(1));var m={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function v(e,t,n){if(m.randomUUID&&!t&&!e)return m.randomUUID();const r=(e=e||{}).random||(e.rng||p)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return function(e,t=0){return(y[e[t+0]]+y[e[t+1]]+y[e[t+2]]+y[e[t+3]]+"-"+y[e[t+4]]+y[e[t+5]]+"-"+y[e[t+6]]+y[e[t+7]]+"-"+y[e[t+8]]+y[e[t+9]]+"-"+y[e[t+10]]+y[e[t+11]]+y[e[t+12]]+y[e[t+13]]+y[e[t+14]]+y[e[t+15]]).toLowerCase()}(r)}var w="testUserId",h=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,a;return t=e,(n=[{key:"ensureUserTestId",value:function(){var e=this.getUserIdFromCookie(w),t=this.getUserIdFromCookie("optimizelyEndUserId"),n=e||t;return n||(n=this.setNewUserIdCookie()),n}},{key:"getUserIdFromCookie",value:function(e){var t=s(e);if(t)return t}},{key:"setNewUserIdCookie",value:function(){var e={domain:"undefined"!=typeof window&&window&&window.location?u(window.location.hostname):"","max-age":15552e3,path:"/"},t=v();return function(e,t,n){var r=["".concat(e,"=").concat(t)].concat(i(Object.entries(n||{}).map((function(e){var t=o(e,2),n=t[0],r=t[1];return"".concat(n,"=").concat(r)}))));document.cookie=r.join("; ")}(w,t,e),t}}])&&r(t.prototype,n),a&&r(t,a),Object.defineProperty(t,"prototype",{writable:!1}),e}()),g=function(){return h.ensureUserTestId()};const b="expCtx";const k=e=>{let t=function(e){var t={},n=e?e.split("; "):[];for(const e of n){var r=e.split("=");t[r[0]]=decodeURIComponent(r.slice(1).join("="))}return t}(document.cookie)[e];return t||(t=localStorage.getItem(e)||""),t},x=(e,t)=>{console.warn(`AB reader failed in ${e}`,t)},I=()=>{try{if(null===(e=window.location.search)||void 0===e?void 0:e.includes("exp_param_ignore"))return console.log("Querystring(exp_param_ignore) requests to bypass experimentation, will return empty list"),[];const t=k(b);if(t||window.experimentClickedAlreadyFired||A(),t)return j(t,"|")}catch(e){x("getAllExperiments",e)}var e;return[]},U=()=>{try{return!!k(b)}catch(e){return x("isAvailable",e),!1}},j=(e,t)=>{const n=[],r=e.split("~");if(null!==r&&2===r.length){r[1].split(t).forEach((t=>{const r=t.split(":");let o=!0;2!=r.length&&(console.warn("Experiment cookie is malformed: ",e),o=!1);const i=r[0].trim();n.some((e=>e.experimentKey===i))&&(console.warn(`Experiment cookie has more than one instance of experiment key ${i}`,e),o=!1),o&&n.push({experimentKey:i,variationKey:r[1].trim()})}))}return n},A=()=>{var e;const t={eventDetail:"context_not_available",experimentName:"cookieless_exp_context"};function n(e){window.tracking.track("Experiment Clicked",e)}(null===(e=null===window||void 0===window?void 0:window.tracking)||void 0===e?void 0:e.track)?n(t):window.addEventListener("trackingReady",(function(){n(t)})),window.experimentClickedAlreadyFired=!0};"undefined"!=typeof window&&(window.abReaderInitialized=!0,U()||t(void 0,void 0,void 0,(function*(){try{const e=yield fetch(`https://context-init-prod.cf-exp.vpsvc.com/?requestUrl=${encodeURIComponent(window.location.origin)}&testUserId=${g()}`),t=yield e.json();t.forEach((e=>{var n;"client"===e.destination&&"Set-Cookie"===e.name&&(document.cookie=e.value);const r=t.find((e=>"client"===e.destination&&"Add-Script"===e.name));if(r){const e=null===(n=/localStorage\.setItem\(\s*"(?<key>\w+)"\s*,\s*"(?<value>[^\s]+)"\s*\)/.exec(r.value))||void 0===n?void 0:n.groups;(null==e?void 0:e.key)&&localStorage.setItem(e.key,e.value)}})),window.dispatchEvent(new Event("variationsResolved"))}catch(e){console.warn("Experiment conext initialization failed")}}))),e.getAllExperiments=I,e.getTestUserId=()=>g(),e.getVariation=e=>{try{const t=I().find((t=>t.experimentKey===e));return t?t.variationKey:null}catch(e){return x("getVariation",e),null}},e.isAvailable=U,e.whenAvailable=e=>{e(U())},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=ab-reader.js.map
